# Data Model: RAG Agent with OpenAI Agents SDK

**Feature**: 002-rag-agent
**Date**: 2025-12-17
**Related Spec**: [spec.md](./spec.md)

## Overview

This document defines the data structures for the RAG agent implementation using OpenAI Agents SDK. The data model covers request/response entities, source attribution, metadata tracking, and error handling.

## Core Entities

### AgentRequest
Represents an incoming query request to the RAG agent.

**Fields**:
- `query` (string): User's natural language question (required, max 1000 characters)
- `top_k` (integer): Number of document chunks to retrieve (optional, default: 5, range: 1-10)
- `include_sources` (boolean): Whether to include source attribution in response (optional, default: true)

**Validation Rules**:
- `query` must not be empty after trimming whitespace
- `query` length must be ≤ 1000 characters
- `top_k` must be a positive integer between 1 and 10
- `include_sources` must be a boolean value

**Example**:
```json
{
  "query": "What is physical AI?",
  "top_k": 5,
  "include_sources": true
}
```

### AgentResponse
Represents the agent's response containing the generated answer, source attribution, and metadata.

**Fields**:
- `answer` (string): Natural language answer generated by the agent
- `sources` (list[SourceChunk]): List of retrieved document chunks used to generate the answer
- `metadata` (ResponseMetadata): Response timing and status information

**Validation Rules**:
- `answer` must not be empty
- `sources` list should contain at least 1 item when content is available
- `metadata` must be present and valid

**Relationships**: Contains multiple SourceChunk entities and one ResponseMetadata entity

### SourceChunk
Represents a retrieved document chunk with metadata and similarity score.

**Fields**:
- `content` (string): Text content of the retrieved chunk
- `url` (string): Source URL of the original document
- `chunk_id` (string): Identifier for the specific chunk
- `document_id` (string): Identifier for the parent document
- `similarity_score` (float): Cosine similarity score (range: 0.0-1.0)
- `position` (integer): Rank in retrieval results (1-indexed)

**Validation Rules**:
- `content` must not be empty
- `url` must be a valid URL format
- `similarity_score` must be between 0.0 and 1.0
- `position` must be a positive integer

**Relationships**: Part of AgentResponse, references original documents in Qdrant

**Example**:
```json
{
  "content": "Physical AI involves sophisticated AI algorithms controlling complex mechanical bodies...",
  "url": "https://hassaanghayas.github.io/physical-ai-robotics-textbook/docs/intro",
  "chunk_id": "intro_chunk_0",
  "document_id": "intro_doc",
  "similarity_score": 0.87,
  "position": 1
}
```

### ResponseMetadata
Contains timing and performance metrics for the request.

**Fields**:
- `response_time_ms` (float): Total time taken to process the request in milliseconds
- `chunk_count` (integer): Number of retrieved chunks
- `embedding_time_ms` (float): Time taken for embedding generation
- `retrieval_time_ms` (float): Time taken for Qdrant retrieval
- `generation_time_ms` (float): Time taken for OpenAI generation

**Validation Rules**:
- All time fields must be non-negative numbers
- `chunk_count` must be non-negative integer

**Relationships**: Part of AgentResponse

**Example**:
```json
{
  "response_time_ms": 3245.5,
  "chunk_count": 3,
  "embedding_time_ms": 250.0,
  "retrieval_time_ms": 150.0,
  "generation_time_ms": 2800.0
}
```

### ErrorResponse
Structured error information returned when requests fail.

**Fields**:
- `error` (string): Error type or category
- `message` (string): Human-readable error message
- `detail` (string): Optional additional debugging information
- `status_code` (integer): HTTP status code

**Validation Rules**:
- `error` must not be empty
- `message` must not be empty
- `status_code` must be a valid HTTP error code (400-599)

**Relationships**: None (standalone error response)

**Example**:
```json
{
  "error": "validation_error",
  "message": "Query cannot be empty",
  "detail": "The 'query' field is required and must contain at least one character",
  "status_code": 400
}
```

## Relationships

```
AgentRequest (1) ──> (1) AgentResponse
                              │
                              ├── (many) SourceChunk
                              └── (1) ResponseMetadata

AgentRequest ──X──> ErrorResponse (on failure)
```

- One AgentRequest generates one AgentResponse (success path)
- One AgentRequest may generate one ErrorResponse (failure path)
- One AgentResponse contains many SourceChunks (0 or more)
- One AgentResponse contains exactly one ResponseMetadata
- SourceChunks reference original documents stored in Qdrant

## State Transitions

### Request States
1. `received` - Request received by API
2. `validating` - Input validation in progress
3. `processing` - Agent processing query
4. `retrieving` - Retrieving documents from Qdrant
5. `generating` - Generating answer with OpenAI
6. `completed` - Request completed successfully
7. `failed` - Request failed with error

### Retry States (for external API calls)
1. `pending` - Awaiting execution
2. `executing` - In progress
3. `retrying` - Retry in progress (after transient failure)
4. `succeeded` - Completed successfully
5. `failed_permanent` - Failed permanently (no more retries)

## Validation Rules Summary

1. **Query Validation**: Must be present, non-empty after trimming, max 1000 characters
2. **Parameter Validation**: top_k must be 1-10, include_sources must be boolean
3. **Content Integrity**: Retrieved content must not be empty
4. **Similarity Scores**: Must be between 0.0 and 1.0
5. **URL Format**: Must be valid URL format (https://...)
6. **Timing Metrics**: All time values must be non-negative
7. **Error Codes**: Must be valid HTTP status codes (400-599)

## Constraints

1. Maximum query length: 1000 characters (to prevent embedding API limits)
2. Maximum top_k value: 10 (to balance quality vs quantity)
3. Minimum similarity threshold: 0.0 (configurable, currently disabled for mock embeddings)
4. Response timeout: 5 seconds (to meet performance requirements)
5. Maximum retries: 3 attempts per external API call
6. Circuit breaker threshold: 5 consecutive failures before opening circuit

## Integration with Qdrant

The SourceChunk entity maps to Qdrant payload structure:

**Qdrant Payload Schema**:
```json
{
  "content": "string",
  "url": "string",
  "chunk_id": "string",
  "document_id": "string",
  "title": "string",
  "chunk_index": "integer",
  "created_at": "string"
}
```

**Mapping**:
- SourceChunk.content ← payload.content
- SourceChunk.url ← payload.url
- SourceChunk.chunk_id ← payload.chunk_id
- SourceChunk.document_id ← payload.document_id
- SourceChunk.similarity_score ← result.score
- SourceChunk.position ← rank in results (1-indexed)

## Performance Considerations

1. **Embedding Generation**: Typically 100-300ms for Cohere API
2. **Qdrant Retrieval**: Typically 50-200ms for vector search
3. **OpenAI Generation**: Typically 2000-4000ms depending on context length
4. **Total Response Time**: Target < 5000ms (p95), typical 3000-4000ms
5. **Concurrent Requests**: Support up to 50 concurrent users

## Future Enhancements

1. **Conversation History**: Add session_id and message history for multi-turn conversations (v2)
2. **User Context**: Add user_id for personalized responses (requires authentication)
3. **Caching**: Add cache_hit field to ResponseMetadata for performance tracking
4. **Re-ranking**: Add re_ranking_score to SourceChunk for hybrid retrieval
5. **Streaming**: Add streaming support for real-time response generation
